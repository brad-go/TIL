# [JavaScript] 싱글 스레드 언어 자바스크립트

## 싱글 스레드? 그게 뭔데?

자바스크립트는 주어진 어떤 시점에서, 단일 JS의 메인 스레드인 이벤트 루프는 최대 코드 한 줄에서 실행된다. 그래서 자바스크립트는 **싱글 스레드 언어(Single Threaded)** 라고 불린다. 즉, **자바스크립트는 한 번에 코드 한 줄만을 실행할 수 있다.**

<div align="center">
  <img src="https://media.vlpt.us/images/cyheum/post/4fedacdf-32cc-46da-893b-bcb3b448a53a/%EB%8B%A4%EC%9A%B4%EB%A1%9C%EB%93%9C.jpg" alt="thread">
</div>

하지만 자바스크립트는 이벤트 루프만 독립적으로 실행도지 않고 웹 브라우저나 node.js같은 멀티 쓰레드 환경에서 실행된다. 즉, **자바스크립트 자체는 싱글 스레드이지만 자바스크립트의 런타임은 싱글 스레드가 아니다.**

## 싱글 스레드로 한 번에 여러 요청을 어떻게 처리할까?

기존 동기식 요청은 코드를 한줄 한줄 차례대로 실행한다. 그래서 하나의 작업에 걸리는 시간에 관계 없이 첫 번째 코드가 실행 된 뒤 다음 코드가 실행된다. 이렇게 되면 앞의 작업시간이 길수록 시간 및 자원의 낭비가 심해진다. 이는 하나의 요청이 완료될 때 까지 기다리지 않고 동시에 다른 작업을 실행하는 비동기 호출로 극복할 수 있다.
그렇다면 시간이 오래 걸리는 코드가 있다면 다음 코드를 실행하지 않고, 계속 대기를 하다가 다음 코드를 실행하는 것일까? 이러한 상황은 사용자의 경험에 별로 좋지 않을 것이다.

```javascript
console.log("Sending request to server!");
setTimeout(function () {
  console.log("Here is your data from the server...");
}, 3000);
console.log("I AM AT THE END OF THE FILE!");
```

위 코드의 출력 결과는 어떨까? 비동기 처리에 대한 이해가 없는 상태에서 위 코드를 보면 아마 다음과 같은 결과값이 나올 거라고 생각할 것이다.

##### 예상 출력

- 'Sending request to server!' 출력
- 3초 후에 'Here is your data from the server...' 출력
- 'I AM AT THE END OF THE FILE!' 출력

##### 실제 출력 결과

- 'Sending request to server!' 출력
- 'I AM AT THE END OF THE FILE!' 출력
- 3초 후에 'Here is your data from the server...' 출력

`setTimeout()` 함수가 먼저 작성되어 있었고, 자바스크립트는 한 번에 한 줄의 코드만을 실행할 수 있다고 했다. 그러나 출력 결과를 보면 `setTimeout()`보다 `console.log("I AM AT THE END OF THE FILE!"`이 먼저 실행되어 출력되고, 3초 뒤에 `setTimeout()`에 적힌 코드가 실행되는 것을 알 수 있다. 싱글 스레드인 자바스크립트에 의하면 `setTimeout()`이 실행되고 3초 후에 나머지 코드가 실행되야 할텐데, 왜 이렇게 동작한 걸까?

#### 자바스크립트의 런타임

이것은 **자바스크립트가 한 것이 아니라 브라우저가 한 것**이다!! 브라우저는 C++ 등의 언어로 만들어져서 자바스크립트가 하지 못하는 일도 할 수 있다. 브라우저가 할 수 있다는 것은 알겠다. 그렇다면 브라우저가 어떻게 할 수 있는걸까?

- **브라우저는 백그라운드에서 특정 작업을 처리할 수 있는 웹 API와 함께 제공**된다(예: requests 만들기 또는 setTimeout).
- 자바스크립트 엔진의 **콜스택**은 이러한 **웹 API 기능을 인식하여 이를 브라우저로 전송하여 처리**한다.
- 브라우저가 이러한 작업을 마치면 **해당 작업이 반환**되고 **콜백으로 스택에 푸시**된다.

위의 코드의 동작(비동기 런타임 과정)과 자바스크립트의 런타임에 대해서 자세히 알고 싶다면 아래의 링크를 보고 글을 마저 읽는다면 좋을 것 같다.

[자바스크립트의 런타임](./Runtime.md)

## 그래서 자바스크립트가 왜 싱글스레드일까?

자바스크립트가 싱글 스레드인 것은 알겠고, 어떻게 동작하는 지도 느낌은 온다. 그런데 왜 멀티 스레드가 아닌 싱글 스레드로 만들어진걸까?

#### 싱글 스레드로 만들어진 이유

##### 1. 웹페이지에서 발생하는 동시성 문제에 대해 신경 쓸 필요가 없다.

##### 2. 비동기 처리를 통해 쉽게 여러 요청을 처리할 수 있다.

자바스크립트가 아닌 멀티 스레드로 구현된 서비스에서는 이 동시성 문제에 대해 정말 많은 신경을 쓴다고 한다. 하지만 자바스크립트는 단일 스레드로 실행되므로 교착 상태와 같은 멀티 스레드 환경에서 발생할 수 있는 복잡한 시나리오를 신경 쓸 필요가 없다.

실제로 구글의 Chrome 브라우저 마저도 기존 웹 페이지에서 엄청난 동시성 문제를 일으킬 수 있다는 이유로 단일 웹 사이트 페이지의 자바스크립트 코드가 동시에 실행되는 것을 허용하지 않는다.

> 한마디로 **쉬워서**!!

## 참고

- [자바스크립트는 왜 싱글 쓰레드일까?](https://chanyeong.com/blog/post/44)
